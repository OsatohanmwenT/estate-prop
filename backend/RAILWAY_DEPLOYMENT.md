# Railway Deployment Guide

This guide walks you through deploying the Estate Management backend to Railway.

## Prerequisites

- Railway account ([railway.app](https://railway.app))
- Railway CLI (optional): `npm i -g @railway/cli`
- Upstash account for QStash ([upstash.com](https://upstash.com))
- SMTP email provider (Gmail, SendGrid, AWS SES, etc.)

## Deployment Steps

### 1. Create Railway Project

1. Go to [railway.app](https://railway.app) and log in
2. Click **"New Project"**
3. Select **"Deploy from GitHub repo"**
4. Connect your GitHub account and select the `estate-prop` repository
5. Set the **Root Directory** to `backend`

### 2. Add PostgreSQL Database

1. In your Railway project, click **"+ New"**
2. Select **"Database"** → **"PostgreSQL"**
3. Railway will automatically provision a PostgreSQL instance
4. The `DATABASE_URL` variable will be automatically added to your service

### 3. Configure Environment Variables

Go to your service → **Variables** tab and add the following:

#### Required Variables

```bash
# Database (auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# JWT Secrets (generate strong random strings)
JWT_SECRET=<generate-32-char-random-string>
REFRESH_TOKEN=<generate-32-char-random-string>

# Server Configuration
BASE_URL=https://${{RAILWAY_PUBLIC_DOMAIN}}
PORT=${{PORT}}
NODE_ENV=production
CORS_ORIGINS=https://your-frontend-domain.com

# Email Configuration (example with Gmail)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-gmail-app-password
EMAIL_FROM=noreply@yourdomain.com
EMAIL_FROM_NAME=Estate Management
EMAIL_SECURE=false

# Upstash QStash (get from console.upstash.com)
QSTASH_URL=https://qstash.upstash.io
QSTASH_TOKEN=<your-qstash-token>
QSTASH_CURRENT_SIGNING_KEY=<your-current-signing-key>
QSTASH_NEXT_SIGNING_KEY=<your-next-signing-key>
```

#### How to Generate JWT Secrets

```bash
# Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# OpenSSL
openssl rand -hex 32
```

#### Setting Up Gmail SMTP

1. Enable 2FA on your Google account
2. Go to [Google App Passwords](https://myaccount.google.com/apppasswords)
3. Generate an app password for "Mail"
4. Use this password for `EMAIL_PASS`

#### Setting Up Upstash QStash

1. Go to [console.upstash.com](https://console.upstash.com)
2. Create a new QStash account (free tier available)
3. Copy the **QStash Token** from the dashboard
4. Copy the **Current Signing Key** and **Next Signing Key**

### 4. Deploy the Application

Railway will automatically:
- Detect the `Dockerfile`
- Build the Docker image
- Run migrations (configured in `railway.toml`)
- Start the application

Monitor the deployment in the **Deployments** tab.

### 5. Verify Deployment

Once deployed, test the health endpoint:

```bash
curl https://your-app.railway.app/health
```

Expected response:
```json
{
  "status": "healthy",
  "database": "connected"
}
```

### 6. Enable Scheduled Jobs

After successful deployment, enable QStash scheduled jobs:

```bash
curl -X POST https://your-app.railway.app/api/v1/cron/setup \
  -H "Content-Type: application/json"
```

This registers the following scheduled jobs:
- **Generate Recurring Invoices** - Daily at 2:00 AM UTC
- **Send Rent Due Reminders** - Daily at 2:00 AM UTC
- **Send Overdue Reminders** - Daily at 2:00 AM UTC
- **Update Expired Leases** - Daily at 2:00 AM UTC
- **Update Overdue Invoices** - Daily at 2:00 AM UTC

### 7. Update Frontend Configuration

Update your frontend's API URL to point to the Railway deployment:

```env
VITE_API_URL=https://your-app.railway.app/api/v1
```

Or

```env
NEXT_PUBLIC_API_URL=https://your-app.railway.app/api/v1
```

## Railway Configuration Files

### `railway.toml`

```toml
[build]
builder = "DOCKERFILE"
dockerfilePath = "Dockerfile"

[deploy]
startCommand = "pnpm db:migrate && pnpm start"
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3
```

## Alternative: Deploy Using Railway CLI

```bash
# Install Railway CLI
npm i -g @railway/cli

# Login
railway login

# Link to existing project or create new one
railway link

# Set environment variables (one at a time)
railway variables set JWT_SECRET="your-secret"
railway variables set REFRESH_TOKEN="your-token"
# ... (set all required variables)

# Deploy
railway up

# View logs
railway logs

# Open in browser
railway open
```

## Manual Migration (If Needed)

If you need to run migrations manually:

```bash
# Using Railway CLI
railway run pnpm db:migrate

# Or via Railway dashboard
# Go to service → Settings → Deploy → Run Command
# Enter: pnpm db:migrate
```

## Troubleshooting

### Build Fails

- Verify `Dockerfile` is in the backend directory
- Check Railway logs for specific errors
- Ensure `pnpm@10.18.2` is specified in `package.json`

### Database Connection Errors

- Verify `DATABASE_URL` is set correctly
- Check PostgreSQL service is running
- Ensure `@neondatabase/serverless` package is installed

### Migration Errors

- Check migration files in `migrations/` directory
- Verify database is empty or has correct schema
- Try running migrations manually via Railway CLI

### CORS Errors

- Verify `CORS_ORIGINS` includes your frontend domain
- Check `BASE_URL` is set to your Railway domain
- Ensure no trailing slashes in URLs

### Email Not Sending

- Verify SMTP credentials
- Check `EMAIL_PORT` (587 for TLS, 465 for SSL)
- Set `EMAIL_SECURE=false` for port 587
- For Gmail, ensure App Password is used (not regular password)

### QStash Jobs Not Running

- Verify Upstash credentials are correct
- Check `/api/v1/cron/setup` was called successfully
- Monitor QStash dashboard for job status
- Ensure `BASE_URL` is accessible publicly

## Monitoring & Logs

### View Logs

```bash
# Via CLI
railway logs

# Via Dashboard
# Go to service → Deployments → Select deployment → View logs
```

### Health Check

```bash
curl https://your-app.railway.app/health
```

### QStash Dashboard

Monitor scheduled jobs at [console.upstash.com/qstash](https://console.upstash.com/qstash)

## Scaling Considerations

### Horizontal Scaling

⚠️ **Note:** The current rate limiter uses in-memory storage and is not suitable for multiple instances.

For horizontal scaling:
1. Implement Redis-based rate limiting
2. Use Railway's Redis addon
3. Update rate limiter middleware to use Redis

### Database Performance

- Railway's PostgreSQL includes connection pooling
- Monitor database metrics in Railway dashboard
- Consider upgrading plan for higher traffic

## Security Checklist

- ✅ Strong JWT secrets (32+ characters)
- ✅ HTTPS enabled (automatic on Railway)
- ✅ CORS configured for production domain only
- ✅ Helmet security headers enabled
- ✅ Rate limiting active
- ✅ Environment variables stored securely
- ✅ Database credentials not exposed
- ✅ Non-root user in Docker container

## Cost Considerations

### Railway Pricing

- **Hobby Plan**: $5/month (500 hours)
- **Pro Plan**: $20/month + usage
- **PostgreSQL**: Charged based on usage

### Upstash QStash

- **Free Tier**: 500 requests/day
- **Pay As You Go**: $1 per 100k requests

## Support

- Railway Docs: [docs.railway.app](https://docs.railway.app)
- Railway Discord: [discord.gg/railway](https://discord.gg/railway)
- Upstash Docs: [upstash.com/docs](https://upstash.com/docs)

## Rollback

To rollback to a previous deployment:

1. Go to **Deployments** tab
2. Find the working deployment
3. Click **"..."** → **"Redeploy"**

Or via CLI:

```bash
railway rollback
```
